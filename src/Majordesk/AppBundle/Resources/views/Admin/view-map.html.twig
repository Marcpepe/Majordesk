{% extends "MajordeskAppBundle:Admin:admin.html.twig" %}

{% block title %}
	Gestion des professeurs - {{ parent() }}
{% endblock %}

{% block navbar %}
	<li><a><i class="icon-angle-right"></i> Gestion des professeurs</a></li>
{% endblock %}
 
{% block admin %}
	<br><br><span class="visible-xs"><br><br></span>
	<div class="col-lg-12">
				<h3><i class="icon-user-md icon-large text-red"></i> Carte des inscrits</h3><br>
				Nombre de professeurs : <strong>{{ professeurs|length }}</strong><br>
				Nombre de familles : <strong>{{ clients|length }}</strong>
				<br><br>
				<div id="map-canvas" style="height:1000px;" ></div>
				<br><br>
	</div>
{% endblock %}

{% block javascripts %}
	{{ parent() }}	
	<script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDAWFFKStzuRNCw21_MD1ZTM-LsLfgdIn0&sensor=false">
    </script>
    <script type="text/javascript">
		var profs = JSON.parse('{{ profs|raw }}');
		var parents = JSON.parse('{{ parents|raw }}');
	    
	    var geocoder;
        var map;
		
		function findGeocodeProf(adresse, nom, id) {
			geocoder.geocode( { 'address': adresse}, function(results, status) {						
				if (status == google.maps.GeocoderStatus.OK) {
					console.log('geocode query returned : lat/long = '+results[0].geometry.location);
					//map.setCenter(results[0].geometry.location);
					var marker = new google.maps.Marker({
					  map: map,
					  position: results[0].geometry.location,
					  title: nom
					});
					// On ajoute le géocode trouvé à la base de données
					addGeocodeToProf(results[0].geometry.location, id);
				} else {
				  console.log('Geocode status pour prof #'+id+': ' + status );
				}	
			});	
		}
		
		function  addGeocodeToProf(location, id){
			console.log("On ajoute le géocode trouvé pour le prof d'id "+id);
			$.ajax({
				type: "POST",
				data: { 'geocode' : JSON.stringify(location) },
				url: Routing.generate("majordesk_app_add_geocode_to_prof", {'id_professeur' : id}),
				success: function() {	
					console.log('Le géocode a bien été ajouté.');
				},
				error: function() {
					console.log('Le géocode n\'a pas été ajouté.');
				}
			});
		}
		
		function findGeocodeWeProf(adresse, nom, id) {
			geocoder.geocode( { 'address': adresse}, function(results, status) {						
				if (status == google.maps.GeocoderStatus.OK) {
					console.log('geocode query returned : lat/long = '+results[0].geometry.location);
					//map.setCenter(results[0].geometry.location);
					var marker = new google.maps.Marker({
					  map: map,
					  position: results[0].geometry.location,
					  title: nom
					});
					// On ajoute le géocode trouvé à la base de données
					addGeocodeWeToProf(results[0].geometry.location, id);
				} else {
				  console.log('Geocode status pour prof #'+id+': ' + status );
				}	
			});	
		}
		
		function  addGeocodeWeToProf(location, id){
			console.log("On ajoute le géocode we trouvé pour le prof d'id "+id);
			$.ajax({
				type: "POST",
				data: { 'geocodeWe' : JSON.stringify(location) },
				url: Routing.generate("majordesk_app_add_geocode_we_to_prof", {'id_professeur' : id}),
				success: function() {	
					console.log('Le géocode a bien été ajouté.');
				},
				error: function() {
					console.log('Le géocode n\'a pas été ajouté.');
				}
			});
		}
		
		function findGeocodeParent(adresse, nom, id) {
			geocoder.geocode( { 'address': adresse}, function(results, status) {						
				if (status == google.maps.GeocoderStatus.OK) {
					console.log('geocode query returned : lat/long = '+results[0].geometry.location);
					//map.setCenter(results[0].geometry.location);
					var marker = new google.maps.Marker({
					  map: map,
					  position: results[0].geometry.location,
					  title: nom
					});
					// On ajoute le géocode trouvé à la base de données
					addGeocodeToParent(results[0].geometry.location, id);
				} else {
				  console.log('Geocode status pour parent #'+id+': ' + status );
				}	
			});	
		}
		
		function  addGeocodeToParent(location, id){
			console.log("On ajoute le géocode trouvé pour le parent d'id "+id);
			$.ajax({
				type: "POST",
				data: { 'geocode' : JSON.stringify(location) },
				url: Routing.generate("majordesk_app_add_geocode_to_parent", {'id_parent' : id}),
				success: function() {	
					console.log('Le géocode a bien été ajouté.');
				},
				error: function() {
					console.log('Le géocode n\'a pas été ajouté.');
				}
			});
		}
		
        function initialize() {
				var mapOptions = {
				  center: new google.maps.LatLng(48.853607, 2.343455),
				  zoom: 12
				};
			map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
			geocoder = new google.maps.Geocoder();
			
			for( i=0; i<Object.keys(profs).length; i++ ) {
				if (profs[i]['hasGeocode'] === 1) {
					  var marker = new google.maps.Marker({
						  map: map,
						  position: new google.maps.LatLng(profs[i]['geocode']),
						  title: profs[i]['nom']
					  });
					  console.log('geocode from database used');
				} else {
					findGeocodeProf(profs[i]['adresse'], profs[i]['nom'], profs[i]['id']);
				}
					
				if (profs[i]['hasAdresseWe'] === 1) {				
					if (profs[i]['hasGeocodeWe'] === 1) {
						  var marker = new google.maps.Marker({
							  map: map,
							  position: new google.maps.LatLng(profs[i]['geocodeWe']),
							  title: nom_prof
						  });
						  console.log('geocode from database used');
					} else {
						findGeocodeWeProf(profs[i]['adresse'], profs[i]['nom'], profs[i]['id']);
					}
				}
			  
			}
			
			for( var i=0; i<Object.keys(parents).length; i++ ) {
				if (parents[i]['hasGeocode'] === 1) {
					  var marker = new google.maps.Marker({
						  map: map,
						  position: new google.maps.LatLng(parents[i]['geocode']),
						  title: nom_parent
					  });
					  console.log('geocode from database used');
				} else {
					findGeocodeProf(parents[i]['adresse'], parents[i]['nom'], parents[i]['id']);
				}
			}
		  }
      google.maps.event.addDomListener(window, 'load', initialize);
    </script>
{% endblock %}